name: Test Build (Self-Hosted)

on:
  workflow_dispatch:

env:
  RUST_VERSION: "1.75.0"
  FLUTTER_VERSION: "3.24.5"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  CARGO_EXPAND_VERSION: "1.0.95"
  FLUTTER_RUST_BRIDGE_VERSION: "1.80.1"

jobs:
  test-linux-build:
    name: Test Linux Build
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fix Directory Permissions
        # Take ownership of the entire workspace to avoid any permission issues
        run: |
          sudo chown -R $(whoami) . || true

      - name: Setup Vcpkg Information
        run: |
          echo "VCPKG_ROOT is $VCPKG_ROOT"
          if [ -d "$VCPKG_ROOT" ]; then
            echo "Vcpkg directory exists."
            $VCPKG_ROOT/vcpkg --version
          else
            echo "Error: VCPKG_ROOT not found!"
            exit 1
          fi

      - name: Generate Bridge Code
        run: |
          # Add flutter to PATH explicitly
          export PATH=$PATH:$FLUTTER_ROOT/bin
          
          # Fix permissions for pubspec.lock EARLY
          if [ -f "flutter/pubspec.lock" ]; then
              sudo chown $(whoami) flutter/pubspec.lock || true
              sudo chmod 666 flutter/pubspec.lock || true
          fi
          
          # Install codegen tools if missing
          if ! command -v cargo-expand &> /dev/null; then
              cargo install cargo-expand --version ${{ env.CARGO_EXPAND_VERSION }} --locked
          fi
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
              cargo install flutter_rust_bridge_codegen --version ${{ env.FLUTTER_RUST_BRIDGE_VERSION }} --features "uuid" --locked
          fi
          
          # Generate code
          $CARGO_HOME/bin/flutter_rust_bridge_codegen --rust-input ./src/flutter_ffi.rs --dart-output ./flutter/lib/generated_bridge.dart --c-output ./flutter/macos/Runner/bridge_generated.h
          # Copy header for iOS (just in case)
          cp ./flutter/macos/Runner/bridge_generated.h ./flutter/ios/Runner/bridge_generated.h || true

      - name: Install Rust dependencies (Vcpkg)
        run: |
          # Install missing build dependencies
          # mfx-dispatch needs autoconf
          if ! command -v autoconf &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y autoconf libtool
          fi

          # Install dependencies for Linux x64
          $VCPKG_ROOT/vcpkg install --triplet x64-linux --x-install-root="$VCPKG_ROOT/installed"

      - name: Build Rust Lib
        run: |
          cargo build --release --features hwcodec,flutter,unix-file-copy-paste

      - name: Build Flutter App
        run: |
          # Add flutter to PATH explicitly
          export PATH=$PATH:$FLUTTER_ROOT/bin
          
          # Ensure flutter dependencies are ready
          cd flutter
          
          # Fix permissions for pubspec.lock
          if [ -f "pubspec.lock" ]; then
              sudo chown $(whoami) pubspec.lock || true
              sudo chmod 666 pubspec.lock || true
          fi
          
          flutter pub get
          cd ..
          
          # Build using the python script, verifying the linux pipeline
          python3 build.py --flutter --skip-cargo

  test-android-build:
    name: Test Android Build
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Fix Directory Permissions
        # Take ownership of the entire workspace to avoid any permission issues
        run: |
          sudo chown -R $(whoami) . || true
      
      - name: Check Environments
        run: |
          echo "ANDROID_HOME: $ANDROID_HOME"
          echo "NDK_HOME: $NDK_HOME"
          ls -d $NDK_HOME

      - name: Generate Bridge Code
        run: |
          # Add flutter to PATH explicitly
          export PATH=$PATH:$FLUTTER_ROOT/bin
          
          # Fix permissions for pubspec.lock EARLY
          if [ -f "flutter/pubspec.lock" ]; then
              sudo chown $(whoami) flutter/pubspec.lock || true
              sudo chmod 666 flutter/pubspec.lock || true
          fi
          
          # Install codegen tools if missing
          if ! command -v cargo-expand &> /dev/null; then
              cargo install cargo-expand --version ${{ env.CARGO_EXPAND_VERSION }} --locked
          fi
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
              cargo install flutter_rust_bridge_codegen --version ${{ env.FLUTTER_RUST_BRIDGE_VERSION }} --features "uuid" --locked
          fi
          
          # Generate code
          $CARGO_HOME/bin/flutter_rust_bridge_codegen --rust-input ./src/flutter_ffi.rs --dart-output ./flutter/lib/generated_bridge.dart --c-output ./flutter/macos/Runner/bridge_generated.h

      - name: Install cargo-ndk
        run: |
          if ! command -v cargo-ndk &> /dev/null; then
              echo "Installing cargo-ndk compatible with Rust 1.75..."
              # 3.5.5 was yanked, trying 3.5.0 which should be stable
              cargo install cargo-ndk --version 3.5.0 --locked
          else
              echo "cargo-ndk already installed."
          fi

      - name: Install Android Dependencies (Vcpkg)
        run: |
          chmod +x ./flutter/build_android_deps.sh
          # Build deps for arm64 only to save time for testing
          # Export ANDROID_NDK_HOME for the script
          export ANDROID_NDK_HOME=$NDK_HOME
          ./flutter/build_android_deps.sh arm64-v8a

      - name: Build Rust Lib for Android
        run: |
          rustup target add aarch64-linux-android
          
          chmod +x ./flutter/ndk_arm64.sh
          ./flutter/ndk_arm64.sh
          
          mkdir -p ./flutter/android/app/src/main/jniLibs/arm64-v8a
          cp ./target/aarch64-linux-android/release/liblibrustdesk.so ./flutter/android/app/src/main/jniLibs/arm64-v8a/librustdesk.so
          
          # Important: Copy libc++_shared.so
          cp $NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/libc++_shared.so ./flutter/android/app/src/main/jniLibs/arm64-v8a/

      - name: Build Flutter APK
        working-directory: ./flutter
        run: |
          # Add flutter to PATH explicitly
          export PATH=$PATH:$FLUTTER_ROOT/bin
          
          # Fix permissions for pubspec.lock if it exists and is owned by root
          if [ -f "pubspec.lock" ]; then
              sudo chown $(whoami) pubspec.lock || true
              sudo chmod 666 pubspec.lock || true
          fi
          
          flutter config --no-analytics
          flutter pub get
          flutter build apk --release --target-platform android-arm64 --split-per-abi

      - name: Verify APK
        run: |
          ls -lh ./flutter/build/app/outputs/flutter-apk/*.apk

