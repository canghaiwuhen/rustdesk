name: Test Linux/Android Build (Self-Hosted)

on:
  workflow_dispatch:

env:
  RUST_VERSION: "1.75"
  FLUTTER_VERSION: "3.24.5"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  NDK_VERSION: "27.2.12479018"

jobs:
  # Step 1: Generate bridge code (shared for all platforms)
  generate-bridge:
    name: Generate Flutter Rust Bridge
    runs-on: [self-hosted, ubuntu-24.04]
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Install prerequisites
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            clang \
            cmake \
            curl \
            gcc \
            git \
            g++ \
            libclang-dev \
            libgtk-3-dev \
            llvm-dev \
            nasm \
            ninja-build \
            pkg-config \
            wget

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: "rustfmt"

      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Install flutter rust bridge deps
        shell: bash
        run: |
          cargo install cargo-expand --version 1.0.95 --locked
          cargo install flutter_rust_bridge_codegen --version 1.80.1 --features "uuid" --locked
          pushd flutter && flutter pub get && popd

      - name: Run flutter rust bridge
        run: |
          flutter_rust_bridge_codegen --rust-input ./src/flutter_ffi.rs --dart-output ./flutter/lib/generated_bridge.dart --c-output ./flutter/linux/bridge_generated.h

      - name: Upload bridge artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bridge-artifact
          path: |
            ./src/bridge_generated.rs
            ./src/bridge_generated.io.rs
            ./flutter/lib/generated_bridge.dart
            ./flutter/lib/generated_bridge.freezed.dart
            ./flutter/linux/bridge_generated.h

  # Step 2: Build Linux client
  build-linux:
    name: Build Linux x64
    needs: [generate-bridge]
    runs-on: [self-hosted, ubuntu-24.04]
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Restore bridge files
        uses: actions/download-artifact@v4
        with:
          name: bridge-artifact
          path: ./

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            curl \
            gcc \
            git \
            g++ \
            libayatana-appindicator3-dev \
            libasound2-dev \
            libclang-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgtk-3-dev \
            libpam0g-dev \
            libpulse-dev \
            libva-dev \
            libxcb-randr0-dev \
            libxcb-shape0-dev \
            libxcb-xfixes0-dev \
            libxdo-dev \
            libxfixes-dev \
            llvm-dev \
            nasm \
            ninja-build \
            pkg-config \
            python3 \
            wget \
            libssl-dev

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          components: "rustfmt"

      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Patch flutter
        shell: bash
        run: |
          cp .github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
          cd $(dirname $(dirname $(which flutter)))
          [[ "3.24.5" == ${{env.FLUTTER_VERSION}} ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff

      - name: Build rustdesk
        env:
          VCPKG_ROOT: /opt/vcpkg
        run: |
          python3 build.py --flutter

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-linux-x64
          path: |
            target/release/rustdesk

  # Step 3: Build Android APK
  build-android:
    name: Build Android APK
    needs: [generate-bridge]
    runs-on: [self-hosted, ubuntu-24.04]
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}

      - name: Restore bridge files
        uses: actions/download-artifact@v4
        with:
          name: bridge-artifact
          path: ./

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            clang \
            cmake \
            curl \
            gcc \
            git \
            g++ \
            libclang-dev \
            llvm-dev \
            nasm \
            ninja-build \
            pkg-config \
            python3 \
            wget \
            openjdk-17-jdk-headless

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: ${{ env.RUST_VERSION }}
          targets: aarch64-linux-android
          components: "rustfmt"

      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Patch flutter
        shell: bash
        run: |
          cp .github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff $(dirname $(dirname $(which flutter)))
          cd $(dirname $(dirname $(which flutter)))
          [[ "3.24.5" == ${{env.FLUTTER_VERSION}} ]] && git apply flutter_3.24.4_dropdown_menu_enableFilter.diff

      - name: Install cargo-ndk
        run: |
          cargo install cargo-ndk --version 3.5.0 --locked

      - name: Build Android dependencies
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.NDK_VERSION }}
        run: |
          cd flutter
          ./build_android_deps.sh arm64-v8a

      - name: Build Android APK
        env:
          ANDROID_NDK_HOME: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ env.NDK_VERSION }}
        run: |
          cd flutter
          flutter build apk --release --target-platform android-arm64 --split-per-abi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android-arm64
          path: |
            flutter/build/app/outputs/flutter-apk/*.apk

