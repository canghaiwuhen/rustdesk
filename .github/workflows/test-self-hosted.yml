name: Test Self-Hosted Builds

on:
  workflow_dispatch:

env:
  RUST_VERSION: "1.75"
  FLUTTER_VERSION: "3.24.5"
  VCPKG_COMMIT_ID: "120deac3062162151622ca4860575a33844ba10b"
  NDK_VERSION: "27.2.12479018"

jobs:
  build-windows:
    name: Build Windows
    runs-on: [self-hosted, windows]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Show Environment
        shell: powershell
        run: |
          Write-Host "ComputerName: $env:COMPUTERNAME"
          Write-Host "OS: $env:OS"
          Write-Host "Rust version:"
          rustc --version
          Write-Host "Flutter version:"
          flutter --version
      
      - name: Setup vcpkg dependencies
        shell: powershell
        run: |
          # 确保 vcpkg 存在
          if (-not (Test-Path "C:\vcpkg")) {
              Write-Host "Installing vcpkg..." -ForegroundColor Yellow
              git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
              cd C:\vcpkg
              .\bootstrap-vcpkg.bat
          }
          
          # 切换到 vcpkg 目录（避免 manifest mode）
          cd C:\vcpkg
          
          # 检查并安装依赖（使用 classic 模式）
          Write-Host "Checking vcpkg packages..." -ForegroundColor Yellow
          
          $packages = @("opus", "libvpx", "libyuv", "aom")
          foreach ($pkg in $packages) {
              $installed = .\vcpkg list | Select-String "${pkg}:x64-windows-static"
              if (-not $installed) {
                  Write-Host "Installing ${pkg}:x64-windows-static..." -ForegroundColor Cyan
                  .\vcpkg install "${pkg}:x64-windows-static" --clean-after-build
              } else {
                  Write-Host "${pkg} already installed" -ForegroundColor Green
              }
          }
          
          # 验证安装
          Write-Host "`nInstalled packages:" -ForegroundColor Green
          .\vcpkg list
          
          # 验证头文件
          if (Test-Path "C:\vcpkg\installed\x64-windows-static\include\vpx\vp8.h") {
              Write-Host "vpx headers verified!" -ForegroundColor Green
          } else {
              Write-Host "ERROR: vpx headers missing!" -ForegroundColor Red
              exit 1
          }
      
      - name: Generate Flutter Bridge Code
        shell: powershell
        run: |
          Write-Host "Generating flutter_rust_bridge code..." -ForegroundColor Yellow
          
          # 安装 flutter_rust_bridge_codegen 如果不存在
          if (-not (Get-Command flutter_rust_bridge_codegen -ErrorAction SilentlyContinue)) {
              Write-Host "Installing flutter_rust_bridge_codegen..." -ForegroundColor Cyan
              cargo install flutter_rust_bridge_codegen --version 1.80.1 --features "uuid" --locked
          }
          
          # 生成桥接代码
          flutter_rust_bridge_codegen --rust-input src/flutter_ffi.rs --dart-output flutter/lib/generated_bridge.dart
          
          Write-Host "Bridge code generated!" -ForegroundColor Green
      
      - name: Build RustDesk Windows
        shell: powershell
        env:
          VCPKG_ROOT: C:\vcpkg
          LIBCLANG_PATH: C:\Program Files\LLVM\bin
        run: |
          # 设置 vcpkg 环境变量
          $env:VCPKG_ROOT = "C:\vcpkg"
          
          # 添加 vcpkg include 路径到 BINDGEN_EXTRA_CLANG_ARGS
          $env:BINDGEN_EXTRA_CLANG_ARGS = "-I C:\vcpkg\installed\x64-windows-static\include"
          
          # 显示环境信息
          Write-Host "VCPKG_ROOT: $env:VCPKG_ROOT"
          Write-Host "BINDGEN_EXTRA_CLANG_ARGS: $env:BINDGEN_EXTRA_CLANG_ARGS"
          
          # 检查 vpx 头文件
          if (Test-Path "C:\vcpkg\installed\x64-windows-static\include\vpx\vp8.h") {
              Write-Host "vpx headers found" -ForegroundColor Green
          } else {
              Write-Host "vpx headers NOT found!" -ForegroundColor Red
          }
          
          # 构建
          python build.py --flutter
        continue-on-error: true
      
      - name: Upload Windows Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-windows
          path: |
            flutter/build/windows/x64/runner/Release/*.exe

  build-linux:
    name: Build Linux
    runs-on: [self-hosted, ubuntu-24.04]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Show Environment
        run: |
          echo "Hostname: $(hostname)"
          echo "OS: $(uname -a)"
          echo "Rust version:"
          rustc --version
          echo "Flutter version:"
          flutter --version
          echo "VCPKG_ROOT: $VCPKG_ROOT"
      
      - name: Generate Flutter Bridge Code
        run: |
          echo "Generating flutter_rust_bridge code..."
          
          # 安装 flutter_rust_bridge_codegen 如果不存在
          if ! command -v flutter_rust_bridge_codegen &> /dev/null; then
              echo "Installing flutter_rust_bridge_codegen..."
              cargo install flutter_rust_bridge_codegen --version 1.80.1 --features "uuid" --locked
          fi
          
          # 生成桥接代码
          flutter_rust_bridge_codegen --rust-input src/flutter_ffi.rs --dart-output flutter/lib/generated_bridge.dart
          
          echo "Bridge code generated!"
      
      - name: Build RustDesk Linux
        run: |
          python3 build.py --flutter
        continue-on-error: true
      
      - name: Upload Linux Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-linux
          path: |
            target/release/rustdesk

  build-android:
    name: Build Android
    runs-on: [self-hosted, ubuntu-24.04]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.PAT_TOKEN }}
      
      - name: Show Environment
        run: |
          echo "Android SDK: $ANDROID_SDK_ROOT"
          echo "NDK: $NDK_HOME"
          echo "Installed packages:"
          sdkmanager --list_installed | head -20
      
      - name: Apply Flutter Patch
        run: |
          cd $FLUTTER_ROOT
          git apply ${{ github.workspace }}/.github/patches/flutter_3.24.4_dropdown_menu_enableFilter.diff || echo "Patch already applied or not needed"
      
      - name: Build Android Dependencies
        run: |
          cd flutter
          ./build_android_deps.sh arm64-v8a
        continue-on-error: true
      
      - name: Build RustDesk Android
        run: |
          rustup target add aarch64-linux-android
          cd flutter
          flutter build apk --release --target-platform android-arm64 --split-per-abi
        continue-on-error: true
      
      - name: Upload Android Artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: rustdesk-android
          path: |
            flutter/build/app/outputs/flutter-apk/*.apk

